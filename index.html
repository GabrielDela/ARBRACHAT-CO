<html>

<head>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="Base.js" type="text/javascript"></script>
  <script src="Plug.js" type="text/javascript"></script>
  <style>
    * {
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    }
  </style>
</head>

<body>
  <a-scene cursor="rayOrigin: mouse">
    <!-- <a-entity camera look-controls mouse-cursor> -->
    <!-- <a-plane position="0 0 -4" rotation="-90 0 0" width="8" height="8" color="white"></a-plane> -->
    <a-entity id="rig" position="10 2 " rotation="0 90 0" style="transition: 0.1s;">
      <a-camera id="camera"></a-camera>
    </a-entity>

    <a-sky id="sky" color="#333333"></a-sky>
  </a-scene>

  <div style="position: fixed; top: 80vh; left: 0; width: 100vw; height: 20vh; background-color: rgb(36, 36, 36);">
    <div style="background-color: rgb(110, 24, 145); width: 100%; height: 10px;"></div>
    <div style="display: flex; width: 100%; height: 100%;">
      <div id="elements"
        style="color: white; border-radius: 3px; margin: 10px; width: 50%; display: flex; flex-wrap: wrap; scroll-behavior: auto; justify-content: center; overflow: auto;">
        <div onclick="addElement()"
          style="width: 100px; height: 100px; background-color: rgb(49, 81, 168); margin: 10px 10px; display: flex; border-radius: 3px;">
          <span style="margin: auto;">BASE</span>
        </div>

        <!-- <div onclick="addElement('CUBE')"
          style="width: 100px; height: 100px; background-color: rgb(49, 81, 168); margin: 10px 10px; display: flex; border-radius: 3px;">
          <span style="margin: auto;">CUBE</span>
        </div>
        <div onclick="addElement('SPHERE')"
          style="width: 100px; height: 100px; background-color: rgb(44, 107, 19); margin: 10px 10px; display: flex; border-radius: 3px;">
          <span style="margin: auto;">SPHERE</span>
        </div> -->
      </div>
      <div id="tools" style="background-color: white; border-radius: 3px; margin: 5px; width: 50%;">
        <button onclick="removeElement()">Remove</button>
      </div>
    </div>
  </div>
</body>

<script>
  var elements = [];
  var selected_id = null;
  var scene = document.querySelector('a-scene');

  let CUBE = new Base({ color: 'red' });

  console.log(CUBE);

  init();

  function init() {
    let base = new Base();
    base.generatePlugs();

    createElementDOM(base);
    elements.push(base);

    base.plugs.forEach(plug => {
      createElementDOM(plug);
      elements.push(plug);
    });
  }

  function createElementDOM(data) {
    element = document.createElement(data.type);
    element.setAttribute('id', data.id);
    element.setAttribute('position', data.position.x + ' ' + data.position.y + ' ' + data.position.z);
    element.setAttribute('width', data.width);
    element.setAttribute('depth', data.depth);
    element.setAttribute('height', data.height);
    element.setAttribute('radius', data.radius);
    element.setAttribute('color', data.color);

    element.addEventListener('click', function (evt) {
      let id = evt.target.id;
      eventClick(id);
    });

    scene.appendChild(element);
  }

  function addElement() {
    if (!selected_id) {
      return;
    }

    var target = elements.find(element => element.id == selected_id);
    var plug = document.getElementById(selected_id);

    var parent_id = target.connections[0];
    var parent = elements.find(element => element.id == parent_id);

    let position = {
      x: parent.position.x,
      y: parent.position.y,
      z: parent.position.z
    };

    position.x = target.pointing == 'east' ? position.x + parent.width : position.x;
    position.x = target.pointing == 'weast' ? position.x - parent.width : position.x;
    position.z = target.pointing == 'north' ? position.z - parent.width : position.z;
    position.z = target.pointing == 'south' ? position.z + parent.width : position.z;

    var base = new Base();
    base.position = position;
    base.generatePlugs();

    // remove plug invert of target.position
    base.plugs.forEach(plug => {
      if (plug.pointing == 'east' && target.pointing == 'weast') {
        base.plugs.splice(base.plugs.indexOf(plug), 1);
      }
      if (plug.pointing == 'weast' && target.pointing == 'east') {
        base.plugs.splice(base.plugs.indexOf(plug), 1);
      }
      if (plug.pointing == 'north' && target.pointing == 'south') {
        base.plugs.splice(base.plugs.indexOf(plug), 1);
      }
      if (plug.pointing == 'south' && target.pointing == 'north') {
        base.plugs.splice(base.plugs.indexOf(plug), 1);
      }
    });

    createElementDOM(base);
    elements.push(base);

    base.plugs.forEach(plug => {
      createElementDOM(plug);
      elements.push(plug);
    });

    target.connections.push(base.id);
    removeElement(plug);
  }

  function eventClick(id) {
    console.log(id);
    console.log(elements);

    elements.forEach(element => {
      let target = document.getElementById(element.id);
      if (!element.is_plug) {
        target.setAttribute('color', 'wheat');
        element.color = 'wheat';
      } else {
        target.setAttribute('color', 'blue');
        element.color = 'blue';
      }
    });

    let element = elements.find(element => element.id == id);
    element.color = 'green';

    let target = document.getElementById(id);
    target.setAttribute('color', element.color);

    selected_id = id;
  }

  function removeElement() {
    if (selected_id != null) {
      let element = elements.filter(element => element.id == selected_id)[0];
      let target = document.getElementById(element.id);

      if (target) {
        if (element.plugs) {
          element.plugs.forEach(plug => {
            let target = document.getElementById(plug.id);
            if(target){
              scene.removeChild(target);
            }
            elements = elements.filter(element => element.id != plug.id);
          });

          element.plugs = [];
        }

        scene.removeChild(target);
        elements = elements.filter(element => element.id != selected_id);
      }
    }

    selected_id = null;
  }

  // zqsd pressed
  document.addEventListener('keydown', function (event) {
    let camera = document.getElementById('rig');

    if (event.keyCode == 104) {
      camera.setAttribute('position', camera.getAttribute('position').x + ' ' + (camera.getAttribute('position').y + 0.25) + ' ' + camera.getAttribute('position').z);
    } else if (event.keyCode == 98) {
      camera.setAttribute('position', camera.getAttribute('position').x + ' ' + (camera.getAttribute('position').y - 0.25) + ' ' + camera.getAttribute('position').z);
    }
  });

  function randomColor() {
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
  }

  function generateId() {
    return Math.random().toString(36).substr(2, 9);
  }

</script>

</html>