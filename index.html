<html>

<head>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <style>
    * {
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    }
  </style>
</head>

<body>
  <a-scene cursor="rayOrigin: mouse">
    <!-- <a-entity camera look-controls mouse-cursor> -->
    <!-- <a-plane position="0 0 -4" rotation="-90 0 0" width="8" height="8" color="white"></a-plane> -->
    <a-entity id="rig" position="10 2 " rotation="0 90 0" style="transition: 0.1s;">
      <a-camera id="camera"></a-camera>
    </a-entity>

    <a-sky id="sky" color="#333333"></a-sky>
  </a-scene>

  <div style="position: fixed; top: 80vh; left: 0; width: 100vw; height: 20vh; background-color: rgb(36, 36, 36);">
    <div style="background-color: rgb(110, 24, 145); width: 100%; height: 10px;"></div>
    <div style="display: flex; width: 100%; height: 100%;">
      <div id="elements"
        style="color: white; border-radius: 3px; margin: 10px; width: 50%; display: flex; flex-wrap: wrap; scroll-behavior: auto; justify-content: center; overflow: auto;">
        <div onclick="addElement()"
          style="width: 100px; height: 100px; background-color: rgb(49, 81, 168); margin: 10px 10px; display: flex; border-radius: 3px;">
          <span style="margin: auto;">BASE</span>
        </div>

        <!-- <div onclick="addElement('CUBE')"
          style="width: 100px; height: 100px; background-color: rgb(49, 81, 168); margin: 10px 10px; display: flex; border-radius: 3px;">
          <span style="margin: auto;">CUBE</span>
        </div>
        <div onclick="addElement('SPHERE')"
          style="width: 100px; height: 100px; background-color: rgb(44, 107, 19); margin: 10px 10px; display: flex; border-radius: 3px;">
          <span style="margin: auto;">SPHERE</span>
        </div> -->
      </div>
      <div id="tools" style="background-color: white; border-radius: 3px; margin: 5px; width: 50%;">
        <button onclick="removeElement()">Remove</button>
      </div>
    </div>
  </div>
</body>

<script>
  var elements = [];
  var selected_id = null;
  var scene = document.querySelector('a-scene');

  init();

  function init() {
    var base = {
      UNIQUE: "BASE",
      id: generateId(),
      is_plug: false,
      type: "a-box",
      position: {
        x: 0,
        y: 0,
        z: 0
      },
      rotation: {
        x: 0,
        y: 0,
        z: 0
      },
      width: 6,
      depth: 6,
      height: 0.25,
      radius: 0,
      color: 'wheat',
      plugs: null,
    };

    base.plugs = [
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'south',
        position: {
          x: base.position.x,
          y: base.position.y,
          z: base.position.z + base.depth / 2,
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'north',
        position: {
          x: base.position.x,
          y: base.position.y,
          z: base.position.z - base.depth / 2,
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'east',
        position: {
          x: base.position.x + base.depth / 2,
          y: base.position.y,
          z: base.position.z
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'west',
        position: {
          x: base.position.x - base.depth / 2,
          y: base.position.y,
          z: base.position.z
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-cylinder",
        pointing: 'south',
        position: {
          x: base.position.x,
          y: base.position.y + 5 / 2,
          z: base.position.z,
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.10,
        depth: 0.10,
        height: 5,
        radius: 1,
        color: 'blue',
        parent: base
      },
    ];

    element = document.createElement(base.type);
    element.setAttribute('id', base.id);
    element.setAttribute('position', base.position.x + ' ' + base.position.y + ' ' + base.position.z);
    element.setAttribute('rotation', base.rotation.x + ' ' + base.rotation.y + ' ' + base.rotation.z);
    element.setAttribute('width', base.width);
    element.setAttribute('depth', base.depth);
    element.setAttribute('height', base.height);
    element.setAttribute('radius', base.radius);
    element.setAttribute('color', base.color);


    base.plugs.forEach(plug => {
      if (!plug.is_used) {
        model = document.createElement(plug.type);
        model.setAttribute('id', plug.id);
        model.setAttribute('position', plug.position.x + ' ' + plug.position.y + ' ' + plug.position.z);
        model.setAttribute('width', plug.width);
        model.setAttribute('depth', plug.depth);
        model.setAttribute('height', plug.height);
        model.setAttribute('radius', plug.radius);
        model.setAttribute('color', plug.color);

        scene.appendChild(model);

        elements.push(plug);

        model.addEventListener('click', function (evt) {
          let id = evt.target.id;

          elements.forEach(element => {
            if (element.is_plug) {
              let target = document.getElementById(element.id);
              target.setAttribute('color', 'blue');
              element.color = 'blue';
            }
          });

          let element = elements.find(element => element.id == id);
          element.color = 'red';

          let target = document.getElementById(id);
          target.setAttribute('color', element.color);

          selected_id = id;
        });
      }
    });

    scene.appendChild(element);
  }

  function addElement() {

    if (!selected_id) {
      return;
    }

    var target = elements.find(element => element.id == selected_id);
    console.log('#########################################');
    console.log(target);

    var parent = target.parent;

    console.log(parent);

    let position = {
      x: parent.position.x,
      y: parent.position.y,
      z: parent.position.z
    };

    position.x = target.pointing == 'east' ? position.x + parent.width : position.x;
    position.x = target.pointing == 'west' ? position.x - parent.width : position.x;
    position.z = target.pointing == 'north' ? position.z - parent.width : position.z;
    position.z = target.pointing == 'south' ? position.z + parent.width : position.z;

    console.log(position);

    var base = {
      UNIQUE: "BASE-AUX",
      id: generateId(),
      is_plug: false,
      type: "a-box",
      position,
      rotation: {
        x: 0,
        y: 0,
        z: 0
      },
      width: 6,
      depth: 6,
      height: 0.25,
      radius: 0,
      color: 'wheat',
      plugs: null,
    };

    base.plugs = [
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'south',
        position: {
          x: base.position.x,
          y: base.position.y,
          z: base.position.z + base.depth / 2,
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'north',
        position: {
          x: base.position.x,
          y: base.position.y,
          z: base.position.z - base.depth / 2,
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'east',
        position: {
          x: base.position.x + base.depth / 2,
          y: base.position.y,
          z: base.position.z
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
      {
        id: generateId(),
        is_plug: true,
        is_used: false,
        type: "a-box",
        pointing: 'west',
        position: {
          x: base.position.x - base.depth / 2,
          y: base.position.y,
          z: base.position.z
        },
        rotation: {
          x: 0,
          y: 0,
          z: 0
        },
        width: 0.40,
        depth: 0.40,
        height: 0.40,
        radius: 1,
        color: 'blue',
        parent: base
      },
    ];

    element = document.createElement(base.type);
    element.setAttribute('id', base.id);
    element.setAttribute('position', base.position.x + ' ' + base.position.y + ' ' + base.position.z);
    element.setAttribute('rotation', base.rotation.x + ' ' + base.rotation.y + ' ' + base.rotation.z);
    element.setAttribute('width', base.width);
    element.setAttribute('depth', base.depth);
    element.setAttribute('height', base.height);
    element.setAttribute('radius', base.radius);
    element.setAttribute('color', base.color);

    base.plugs.forEach(plug => {
      if (!plug.is_used) {
        model = document.createElement(plug.type);
        model.setAttribute('id', plug.id);
        model.setAttribute('position', plug.position.x + ' ' + plug.position.y + ' ' + plug.position.z);
        model.setAttribute('width', plug.width);
        model.setAttribute('depth', plug.depth);
        model.setAttribute('height', plug.height);
        model.setAttribute('radius', plug.radius);
        model.setAttribute('color', plug.color);

        scene.appendChild(model);

        elements.push(plug);

        model.addEventListener('click', function (evt) {
          let id = evt.target.id;

          elements.forEach(element => {
            if (element.is_plug) {
              let target = document.getElementById(element.id);
              target.setAttribute('color', 'blue');
              element.color = 'blue';
            }
          });

          let element = elements.find(element => element.id == id);
          element.color = 'red';

          let target = document.getElementById(id);
          target.setAttribute('color', element.color);

          selected_id = id;
        });
      }
    });

    scene.appendChild(element);

    elements.push(base);
  }

  function removeElement() {
    if (selected_id != null) {
      var element = document.getElementById(selected_id);
      if (element) {
        scene.removeChild(element);
        elements = elements.filter(element => element.id != selected_id);
      }
    }
  }

  function randomColor() {
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
  }

  function generateId() {
    return Math.random().toString(36).substr(2, 9);
  }

  // zqsd pressed
    document.addEventListener('keydown', function (event) {
      let camera = document.getElementById('rig');

      if (event.keyCode == 104) {
        camera.setAttribute('position', camera.getAttribute('position').x + ' ' + (camera.getAttribute('position').y + 0.25) + ' ' + camera.getAttribute('position').z);
      } else if (event.keyCode == 98) {
        camera.setAttribute('position', camera.getAttribute('position').x + ' ' + (camera.getAttribute('position').y - 0.25) + ' ' + camera.getAttribute('position').z);
      } 
    });


</script>

</html>